<html>
<head><Title>Media Display Screen</title>
<script src="//code.jquery.com/jquery-1.10.2.min.js" type="text/javascript"></script>

<style>
	body{
	margin: 0; 
	padding: 0; 
	padding-top: 0px;
	text-align: center;}

	#main {
	height: 100%;
	width: 100%;
	position: absolute;
	border: 0px;
	padding: 0;
	margin: 0 auto;}

	#content{
	height: 100%;
	width: 100%;
	margin-top: 0px;
	margin-right:0px;}


</style>


</head>
<body>
<div id="main">
	<div id="content">
		<div id="image_container"></div>
	</div>
	<div id="filename"></div>
</div>

<div id="log"></div>

<script type="text/javascript">
//alert('hi');
// Function to change the media
function change_media(cnt, duration) {

	// Make a call to the server to get what we should show
	var request = $.ajax({
		url: "http://localhost:8080/get_media",
		type: "GET",
		datatype: 'json',
		data: { cnt: cnt, duration: duration },
	});

	 // Deal with Response
	 request.done(function( obj ) {
		var embed_html = '';
		var media_path = false;
		var media_type = false;
		var media_host = false;

		// start with a clean log element
		$( "#log" ).html( "" );

		// Make sure the key's we expect are there
		$.each( obj, function( key, value ) {
			if (key = 'media_path') {media_url = true;}
			if (key = 'media_type') {media_type = true;}
			if (key = 'media_host') {media_host = true;}
		});

		//TODO: clean up how the URL is built
		if (media_url && media_type && media_host) {
			if (obj['media_type'] == 'image/jpeg') {
				//embed_html = '<img id="my_image" src="http://192.168.2.102:8080/images/' +  obj['media_path'] + '">';
				embed_html = '<img id="my_image" src="http://' +  obj['media_host'] + ':8080/images/' +  obj['media_path'] + '">';
			} else if (obj['media_type'] == 'movie/quicktime') {
				// TODO: get the correct HTML to embedd quicktime movies in Chrome on Linux
				// TODO: mov and maybe avi
				// TODO: figure out why my .mov files look like text
				// SEE: https://github.com/malsup/media/tree/master
			//	embed_html = '<a class="media" href="http://' +  obj['media_host'] + ':8080/images/' +  obj['media_path'] + '">qtMovie</a>';

				embed_html = '<object classid="clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B" ';
				embed_html = embed_html + 'codebase="http://www.apple.com/qtactivex/qtplugin.cab" width="95%" height="95%">';
				embed_html = embed_html + '<param name="src" value="myvid.mov" />';
				embed_html = embed_html + '<param name="controller" value="true" />';
				embed_html = embed_html + '<object id="my_image" type="video/quicktime" data="';
				embed_html = embed_html + 'http://' +  obj['media_host'] + ':8080/images/' +  obj['media_path'];
				embed_html = embed_html + '" width="95%" height="95%" class="mov">';
				embed_html = embed_html + '<param name="controller" value="true" />';
				embed_html = embed_html + '</object>';
				embed_html = embed_html + '</object>';

			} else if (obj['media_type'] == 'movie/mp4') {
				embed_html = '<video width="320" height="240" controls>';
				embed_html = embed_html + '<source src="movie.mp4" type="video/mp4">';
				embed_html = embed_html + '</video>';
			} else {
				$("#log").html("Media type not handled: " + obj['media_type']);
			}

			// Display file name if configured for that
			$("#filename").html(obj['media_path']);
		} else {
			$("#log").html("Media type or url not found in: " + obj );
		}

		// Resize content to main size with a boarder at bottom to show image path
		$("#content").css({"height" : ($("#main").height()-20) + "px", "width" : $("#main").width() + "px"});

		// Load the image into the page
		$("#image_container").html( embed_html );   

		$("#my_image").css({"display" : "none"});

		// Once loaded resize so that it fits in the screen correctly
		//$("#my_image").load(function(){
		$("#my_image").ready(function(){
			var mheight = $("#content").height();
			var mwidth = $("#content").width();
			var iheight = $(this).height();
			var iwidth = $(this).width();
			for (var i=100;i>0;i--) { 
				var h = iheight * (i/100);
				var w = iwidth * (i/100);
				// Debug: alert(i + " h" + h + " w" + w + " vs h " + mheight + " w"  + mwidth);
				if (h < mheight && w > mwidth) {
					$(this).css({"width": "100%"});
					break;
				}
				if (w < mwidth && h > mheight) {
					$(this).css({"height": "100%"});
					break;
				}
			}
			$("#my_image").css({"display" : "inline"});
		});

	});

	// Deal with Failure 
	request.fail(function( jqXHR, textStatus ) {
	//alert( "Request failed: " + textStatus );
	$("#log").html("Request failed: " + textStatus);
	});

	// last thing it does is set itself up to be called again
	cnt++;
	duration = 10000;
	//setTimeout(function(){change_media(cnt, duration);}, duration);
	return true;
}


// Start the whole thing running
change_media(0, 3000);

</script>
</body>
</html>
